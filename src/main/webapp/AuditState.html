<!DOCTYPE html>
<html>
  <head>

    <title></title>
    <meta charset="utf-8">

    

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<!-- iziToast -->
	<link rel="stylesheet" href="css/iziToast.min.css">
	
	
	
	<script src="js/jquery-1.11.0.min.js"></script>
	
	
    <!-- 表格依赖 -->
    <script src="js/raydreams.js"></script>
    <script src="js/data.js"></script>
    
    <!-- iziToast -->
    <script src="js/iziToast.min.js" type="text/javascript"></script>
    <style>
    	
    </style>
    
    
  </head>
  
  <body>
	
	<div style="margin:auto; width:95%;padding:2em 0;">
		<div id="dataTable" class="table table-striped table-bordered" cellspacing="0" width="100%">
	            
		</div>
	</div>
	
	<div id="confirmDeleteModal" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
	  <div class="modal-dialog modal-sm" role="document">
	    <div class="modal-content">
	      	<div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title">确认撤销？</h4>
		      </div>
		      <div class="modal-body">
		        <p id="revokeObject">One fine body&hellip;</p>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
		        <button id="confirmDelete" type="button" class="btn btn-danger">确定</button>
		      </div>
	    </div>
	  </div>
	</div>
	<script src="js/jquery-1.11.0.min.js" type="text/javascript"></script>
	
	<script src="js/bootstrap.min.js"></script>
	<script src="js/raydreams.js"></script>
	<script src="js/data.js"></script>
	<script type="text/javascript">
	//		var testjson='[{"customerid":"CTID_0000004","customertype":"优质客户","filesurl":"c://xczxc.rar","isnewfiles":"0","lineNumber":"6","managerid":"MSID_0000002","ranklineid":"RK20180407123235","state":"排队待审核","texts":"","uploaddate":"2018-04-05 00:00:00.0"},{"customerid":"CTID_0000003","customertype":"普通客户","filesurl":"c://nvv.rar","isnewfiles":"0","lineNumber":"7","managerid":"MSID_0000002","ranklineid":"RK20180408123245","state":"排队待审核","texts":"","uploaddate":"2018-04-05 00:00:00.0"},{"customerid":"CTID_0000004","customertype":"优质客户","filesurl":"c://dsabbbd.rar","isnewfiles":"0","lineNumber":"8","managerid":"MSID_0000002","ranklineid":"RK20180409123255","state":"排队待审核","texts":"","uploaddate":"2018-04-05 00:00:00.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":";spring学习笔记.rar","isnewfiles":"1","lineNumber":"12","managerid":"MSID_0000005","ranklineid":"RK20180417224927","state":"排队待审核","texts":"","uploaddate":"2018-04-17 22:49:27.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":";Snipaste_2018_04_17_10_31_45.rar","isnewfiles":"1","lineNumber":"13","managerid":"MSID_0000005","ranklineid":"RK20180417225005","state":"排队待审核","texts":"","uploaddate":"2018-04-17 22:50:05.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":";Snipaste_2018_04_17_10_31_45.rar","isnewfiles":"1","lineNumber":"14","managerid":"MSID_0000005","ranklineid":"RK20180417225015","state":"排队待审核","texts":"","uploaddate":"2018-04-17 22:50:15.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":"Snipaste_2018_04_17_10_31_45.rar","isnewfiles":"1","lineNumber":"15","managerid":"MSID_0000005","ranklineid":"RK20180417225135","state":"排队待审核","texts":"","uploaddate":"2018-04-17 22:51:35.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":"spring学习笔记.rar","isnewfiles":"1","lineNumber":"16","managerid":"MSID_0000005","ranklineid":"RK20180418174228","state":"排队待审核","texts":"","uploaddate":"2018-04-18 17:42:28.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":"spring学习笔记.rar","isnewfiles":"1","lineNumber":"17","managerid":"MSID_0000005","ranklineid":"RK20180418174535","state":"排队待审核","texts":"","uploaddate":"2018-04-18 17:45:35.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":"新建文本文档.txt","isnewfiles":"1","lineNumber":"18","managerid":"MSID_0000005","ranklineid":"RK20180418182719","state":"排队待审核","texts":"","uploaddate":"2018-04-18 18:27:19.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":"新建文本文档.txt","isnewfiles":"1","lineNumber":"19","managerid":"MSID_0000005","ranklineid":"RK20180418182751","state":"排队待审核","texts":"","uploaddate":"2018-04-18 18:27:51.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":"新建文本文档.txt","isnewfiles":"1","lineNumber":"20","managerid":"MSID_0000005","ranklineid":"RK20180418182843","state":"排队待审核","texts":"","uploaddate":"2018-04-18 18:28:43.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":"新建文本文档.txt","isnewfiles":"1","lineNumber":"21","managerid":"MSID_0000005","ranklineid":"RK20180418182937","state":"排队待审核","texts":"","uploaddate":"2018-04-18 18:29:37.0"},{"customerid":"CTID_0000002","customertype":"优质客户","filesurl":"c://dsabbbd.rar","isnewfiles":"1","lineNumber":"9","managerid":"MSID_0000002","ranklineid":"RK20180509123255","state":"排队待审核","texts":"","uploaddate":"2018-04-05 00:00:00.0"},{"customerid":"CTID_0000002","customertype":"普通客户","filesurl":"c://dsabbbd.rar","isnewfiles":"1","lineNumber":"11","managerid":"MSID_0000002","ranklineid":"RK20182509123255","state":"排队待审核","texts":"","uploaddate":"2018-04-05 00:00:00.0"},{"customerid":"CTID_0000005","customertype":"优质客户","filesurl":"c://dsabbbd.rar","isnewfiles":"1","lineNumber":"10","managerid":"MSID_0000002","ranklineid":"RK21181509123255","state":"排队待审核","texts":"","uploaddate":"2018-04-05 00:00:00.0"},{"customerid":"CTID_0000001","customertype":"普通客户","filesurl":"test用","isnewfiles":"1","lineNumber":"23","managerid":"MSID_0000001","ranklineid":"RKID04192018100 ","state":"排队待审核","texts":"调试用","uploaddate":"2018-04-19 13:00:15.42"}]';
			//testjson=eval(testjson);
			// dataTable对象
	        var dataTable = null;
	        
	        //RayTable当前行指针
			var currentRow = null;
			var currentRowIndex = null;
			
			//保存当前RayData
			var rayData = null;
			
			
	        $(document).ready(function () {

				var AuditedQueue;
				$.ajax({
					url:"ranklines/query_with_status",
					data:{},//选择一次性加载，无需向后台传值
					async:false,method:'post',
					success:function(data){
						
						AuditQueue=JSON.parse(data);
						rayData=AuditQueue;
					}
				});
	        	dataTable = $("#dataTable").raytable({
	            	//datasource: { data: [], keyfield: 'id' },
	            	datasource:{data:AuditQueue},
	            	
	            	columns: [
	                    //{ title: "文件名", icons: [{ glyph: "glyphicon-info-sign", handler: iconAction, data:"id" }], renderIf: isManager },
	                    { field: "customerid", title: "客户ID", sort:false },
	                    { field: "customertype", title: "客户性质", sort: false },
	                    { field: "filesurl", title: "文件路径"},
	                    { field: "isnewfiles", title: "是否下载过", format:Downloaded },
	                    { field: "state", title: "文件状态"   },
	                    { field: "uploaddate", title: "上传时间"   },
	                    //{ field: "birthDate", title: "DOB", sort: true, format: parseDate },
	                    { 
	                    	title: "申请优先", 
	                    	icons: [
	                    		
	                    		{ glyph: "glyphicon-circle-arrow-up", format:operationPrior ,handler: iconAction, data: "id" }
	                    	],
	                    	width:20 
	                    },
	                    { 
	                    	title: "撤销审核", 
	                    	icons: [
	                    		
	                    		{ glyph: "glyphicon-trash" ,handler: revokeFile, data: "id" }
	                    	],
	                    	width:20,
	                    	renderIf:isAbleForDelete 
	                    },
	                    { 
	                    	title: "下载文件", 
	                    	icons: [
	                    		
	                    		{ glyph: "glyphicon-circle-arrow-down" ,handler: downloadFile, data: "id" }
	                    	],
	                    	width:20,
	                    	
	                    }
	                ],
	            	pagesize: 15,
	            	maxPageButtons: 10,
	            	rowNumbers: true,
	            	rowClickHandler: rowAction
	        	});
				//dataTable.data(myData,'dataTable');
	            //jQuery(".glyphicon").css('cursor', 'pointer');
	            
	            // load some default
	            //doLoad(jQuery("#dataTable"));
	            
	            //用户确认删除
	            $("#confirmDelete").click(function(){
	            	//alert(currentRow.ranklineid);
	            	$.ajax({
	            		url:"ranklines/delete_item",
	            		data:{ranklineid:currentRow.ranklineid},
	            		async:false,method:'post',
	            		success:function(response){
	            			response=JSON.parse(response);
	            			
	            			iziToast.show({
							    title: response[0].title,
							    message: response[0].message,
							    color:response[0].color,// blue, red, green, yellow
							    layout:1
							});
							$('#confirmDeleteModal').modal('hide');
							rayData.splice(currentRowIndex,1);
							dataTable.data(rayData,'');
	            		}
	            	});
	            });        
         
	        });//document ready
			
			function Downloaded(data){
				if(data.isnewfiles==0){
					return "新文件";
				}
				if(data.isnewfiles==1){
					return "审核员已下载过此文件";
				}
			}
			function isAbleForDelete(data){
				if(data.isnewfiles=="0"){
					return true;
				}
				if(data.isnewfiles=="1"){
					return false;
				}
			}
			//撤销审核
			function revokeFile(event){
				var data = jQuery(event.currentTarget).data('ray-data');
				
				var rowindex = event.data.rowIdx;
				var rowdata = dataTable.datasource.data[rowindex];
				currentRow = rowdata;
				currentRowIndex = rowindex;
				$("#revokeObject").html("是否撤销客户"+rowdata.customerid+"于<br/>"+rowdata.uploaddate+"上传的<br/>"+rowdata.filesurl+"?");
				$('#confirmDeleteModal').modal('show');
			}
			//文件下载
			function downloadFile(event){
				
				var data = jQuery(event.currentTarget).data('ray-data');
				
				var rowindex = event.data.rowIdx;
				var rowdata = dataTable.datasource.data[rowindex];
				$.ajax({
					url:"load/download",
					data:{filename:rowdata.filesurl},
					async:true,method:'post',
					success:function(data){
						//data=JSON.parse(data);
						try{
							data=JSON.parse(data);
							if(data[0].isExist == "false" || data[0].isExist == false){
								iziToast.show({
								    title: data[0].title,
								    message: "找不到文件："+rowdata.filesurl,
								    color: data[0].color,
								    layout: 1
								});
							}else{
								iziToast.show({
								    title: "异常情况",
								    message: "您的文件内容是JSON格式的，我们不允许包含JSON的内容的下载，请联系管理员解决，或者将您文件的内容改为非标准JSON格式",
								    color: "red",
								    layout: 1,
								    timeout: 10000,
								});
							}
							
						}catch(e){
							iziToast.show({
							    title: "文件可以下载",
							    message: "正在准备下载。。。",
							    color:"blue",
							    layout:1,
							    
							});
							window.open("load/download?filename="+rowdata.filesurl);
						}
						//data=JSON.parse(data);
						/*
						iziToast.show({
						    title: data[0].title,
						    message: data[0].message,
						    color:data[0].color,
						    layout:1
						});
						window.open("load/download?filename=新建文本文档.txt");*/
					}
				});
			}
			

			// icon clicked event handler
	        function iconAction(event)
	        {
	            // jquery to get the record ID back out
	            var data = jQuery(event.target).data('ray-data');
	            alert('glyph icon data is ' + data);
	            alert('You clicked the icon with data = ' + event.data.id + ' on row ' + event.data.rowIdx );
	        }
	        
	        // row clicked handler
	        function rowAction(event)
	        {
	            // jquery to get the record ID back out
	            //var id = jQuery(event.target).data('ray-key');
	            //alert('You clicked row ' + event.data.rowIdx + ' with object ID ' + event.data.id );
	        }
	        
	        // boolean handler to determine if the cell content is rendered
	    	function isManager(item)
	    	{
	    		return (item.grade > 4);
	    	}
	    	
	    	// custom format handler
	    	//function parseDate(item)
	    	//{
	    		// source is ISO 8601
	    		//var d = new Date(item.birthDate);
	    		//return d.toDateString();
	    	//}
	    	function operationPrior(item){
	    		return "t"+item.grade;
	    	}
			
	    </script>
  </body>
</html>
